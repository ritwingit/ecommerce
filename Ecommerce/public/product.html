<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DarkCart | Product Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050b18;
        --bg-elevated: #0b1020;
        --bg-card: #111827;
        --accent: #fbbf24;
        --accent-soft: rgba(251, 191, 36, 0.16);
        --accent-strong: #f59e0b;
        --text: #e5e7eb;
        --text-soft: #9ca3af;
        --border-subtle: #1f2937;
        --danger: #ef4444;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
          circle at top,
          #111827 0,
          #020617 45%,
          #000 100%
        );
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      /* NAVBAR */

      .navbar {
        background: radial-gradient(circle at top, #020617 0, #000 60%);
        border-bottom: 1px solid var(--border-subtle);
        padding: 0.5rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        position: sticky;
        top: 0;
        z-index: 20;
      }

      .nav-logo {
        display: flex;
        align-items: baseline;
        gap: 0.15rem;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .nav-logo-main {
        font-size: 1.15rem;
      }

      .nav-logo-dot {
        font-size: 1.2rem;
        color: var(--accent);
      }

      .nav-logo-sub {
        font-size: 0.7rem;
        color: var(--text-soft);
      }

      .nav-cart {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        cursor: pointer;
        padding: 0.45rem 0.8rem;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.8);
        font-size: 0.8rem;
      }

      .nav-cart-count {
        background: var(--accent);
        color: #111827;
        font-size: 0.65rem;
        font-weight: 700;
        border-radius: 999px;
        padding: 0.1rem 0.35rem;
      }

      /* PAGE LAYOUT */

      .main {
        flex: 1;
        padding: 1.2rem 1.5rem 2.5rem;
      }

      .breadcrumbs {
        font-size: 0.75rem;
        color: var(--text-soft);
        margin-bottom: 0.8rem;
      }

      .product-layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 3fr) minmax(0, 2fr);
        gap: 1.5rem;
      }

      @media (max-width: 900px) {
        .product-layout {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: radial-gradient(circle at top, #020617 0, #020617 60%);
        border-radius: 1.1rem;
        border: 1px solid rgba(31, 41, 55, 0.95);
        padding: 1rem;
        box-shadow: 0 18px 44px rgba(15, 23, 42, 0.8);
      }

      .image-panel {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 260px;
      }

      .image-wrap {
        background: radial-gradient(circle at center, #020617 0, #020617 50%);
        border-radius: 1rem;
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
      }

      .image-wrap img {
        max-width: 100%;
        max-height: 320px;
        object-fit: contain;
      }

      .details-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }

      .details-badge {
        font-size: 0.7rem;
        border-radius: 999px;
        padding: 0.16rem 0.55rem;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-soft);
        display: inline-block;
        margin-bottom: 0.5rem;
      }

      .rating-line {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        margin-bottom: 0.4rem;
      }

      .stars {
        color: #facc15;
      }

      .details-price {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--accent);
        margin: 0.4rem 0;
      }

      .details-stock {
        font-size: 0.8rem;
        color: #bbf7d0;
      }

      .details-description {
        font-size: 0.85rem;
        color: var(--text-soft);
        margin-top: 0.7rem;
        line-height: 1.5;
      }

      .buy-panel-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .buy-price {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 0.4rem;
      }

      .buy-actions {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-top: 0.4rem;
      }

      .btn {
        width: 100%;
        font-size: 0.85rem;
        padding: 0.5rem 0.6rem;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-soft);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--accent),
          var(--accent-strong)
        );
        border-color: rgba(202, 138, 4, 0.9);
        color: #111827;
        font-weight: 600;
      }

      .btn-secondary {
        border-color: rgba(148, 163, 184, 0.8);
      }

      .status {
        font-size: 0.75rem;
        color: var(--text-soft);
        margin-top: 0.4rem;
        min-height: 1em;
      }

      .status.error {
        color: #fecaca;
      }

      .status.success {
        color: #bbf7d0;
      }

      /* REVIEWS */

      .reviews-section {
        margin-top: 1.2rem;
      }

      .reviews-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.4rem;
      }

      .review-item {
        margin-top: 0.6rem;
        padding-top: 0.6rem;
        border-top: 1px solid rgba(31, 41, 55, 0.9);
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 0.8rem;
      }

      .review-name {
        font-weight: 600;
      }

      .review-date {
        color: var(--text-soft);
        font-size: 0.7rem;
      }

      .review-text {
        font-size: 0.8rem;
        color: var(--text-soft);
        margin-top: 0.3rem;
      }

      .review-stars {
        color: #facc15;
        font-size: 0.8rem;
      }

      .review-form {
        margin-top: 1rem;
        padding: 0.7rem;
        border-radius: 0.8rem;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .review-form-row {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        margin-bottom: 0.5rem;
      }

      .review-label {
        font-size: 0.75rem;
        color: var(--text-soft);
      }

      .review-select,
      .review-textarea {
        border-radius: 0.6rem;
        border: 1px solid var(--border-subtle);
        background: #020617;
        color: var(--text);
        font-size: 0.8rem;
        padding: 0.4rem 0.5rem;
        outline: none;
      }

      .review-textarea {
        min-height: 70px;
        resize: vertical;
      }

      .footer {
        border-top: 1px solid var(--border-subtle);
        padding: 0.75rem 1.5rem 1.25rem;
        font-size: 0.7rem;
        color: var(--text-soft);
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
        background: radial-gradient(circle at bottom, #020617 0, #000 60%);
      }

      @media (max-width: 700px) {
        .main {
          padding: 0.75rem 0.75rem 2rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- NAVBAR -->
    <header class="navbar">
      <a href="/index.html" class="nav-logo">
        <span class="nav-logo-main">Dark</span>
        <span class="nav-logo-main nav-logo-dot">.</span>
        <span class="nav-logo-main">Cart</span>
        <span class="nav-logo-sub">india</span>
      </a>

      <div class="nav-cart" id="navCart">
        üõí
        <span>Cart</span>
        <span class="nav-cart-count" id="cartCount">0</span>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div class="breadcrumbs">
        <a href="/index.html" style="color: var(--accent)">Home</a> ‚Ä∫
        <span id="breadcrumbCategory">Product</span>
      </div>

      <section class="product-layout">
        <!-- IMAGE -->
        <div class="panel image-panel">
          <div class="image-wrap" id="imageWrap">
            <span style="font-size: 3rem; opacity: 0.35">üì¶</span>
          </div>
        </div>

        <!-- DETAILS -->
        <div class="panel" id="detailsPanel">
          <div class="details-badge" id="categoryBadge">Category</div>
          <h1 class="details-title" id="productTitle">Loading‚Ä¶</h1>

          <div class="rating-line">
            <span class="stars" id="ratingStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
            <span id="ratingValue">(0)</span>
            <span id="reviewCount">0 reviews</span>
          </div>

          <div class="details-price" id="productPrice">‚Çπ0</div>
          <div class="details-stock" id="stockStatus"></div>

          <div class="details-description" id="productDescription">
            Loading description‚Ä¶
          </div>

          <div class="reviews-section">
            <div class="reviews-title">Customer Reviews</div>
            <div id="reviewsList"></div>

            <div class="review-form" id="reviewFormWrapper">
              <div style="font-size: 0.8rem; margin-bottom: 0.4rem">
                Write a review
              </div>
              <div class="review-form-row">
                <label class="review-label" for="reviewRating">Rating</label>
                <select id="reviewRating" class="review-select">
                  <option value="">Select‚Ä¶</option>
                  <option value="5">‚≠ê 5 - Excellent</option>
                  <option value="4">‚≠ê 4 - Very good</option>
                  <option value="3">‚≠ê 3 - Average</option>
                  <option value="2">‚≠ê 2 - Poor</option>
                  <option value="1">‚≠ê 1 - Terrible</option>
                </select>
              </div>
              <div class="review-form-row">
                <label class="review-label" for="reviewComment">Comment</label>
                <textarea
                  id="reviewComment"
                  class="review-textarea"
                  placeholder="Share your experience with this product..."
                ></textarea>
              </div>
              <button
                class="btn btn-primary"
                id="submitReviewBtn"
                type="button"
              >
                Submit Review
              </button>
              <div class="status" id="reviewStatus"></div>
            </div>
          </div>
        </div>

        <!-- BUY BOX -->
        <aside class="panel">
          <div class="buy-panel-title">Purchase Options</div>
          <div class="buy-price" id="buyPrice">‚Çπ0</div>
          <div style="font-size: 0.75rem; color: var(--text-soft)">
            Free delivery on eligible orders. Cash on Delivery available.
          </div>

          <div class="buy-actions">
            <button class="btn btn-primary" id="addToCartBtn" type="button">
              üõí Add to Cart
            </button>
          </div>

          <div class="status" id="buyStatus"></div>
        </aside>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <span>DarkCart ‚Ä¢ Product details powered by your backend.</span>
      <span>Next: improve with similar products & recommendations.</span>
    </footer>

    <script>
      // ====== BASIC HELPERS ======

      const navCart = document.getElementById("navCart");
      const cartCountEl = document.getElementById("cartCount");

      const breadcrumbCategory = document.getElementById("breadcrumbCategory");
      const imageWrap = document.getElementById("imageWrap");
      const productTitleEl = document.getElementById("productTitle");
      const productPriceEl = document.getElementById("productPrice");
      const productDescriptionEl =
        document.getElementById("productDescription");
      const stockStatusEl = document.getElementById("stockStatus");
      const categoryBadgeEl = document.getElementById("categoryBadge");

      const ratingStarsEl = document.getElementById("ratingStars");
      const ratingValueEl = document.getElementById("ratingValue");
      const reviewCountEl = document.getElementById("reviewCount");
      const reviewsListEl = document.getElementById("reviewsList");

      const addToCartBtn = document.getElementById("addToCartBtn");
      const buyNowBtn = document.getElementById("buyNowBtn");
      const buyPriceEl = document.getElementById("buyPrice");
      const buyStatusEl = document.getElementById("buyStatus");

      const reviewFormWrapper = document.getElementById("reviewFormWrapper");
      const reviewRatingEl = document.getElementById("reviewRating");
      const reviewCommentEl = document.getElementById("reviewComment");
      const submitReviewBtn = document.getElementById("submitReviewBtn");
      const reviewStatusEl = document.getElementById("reviewStatus");

      let currentProduct = null;

      function getToken() {
        return localStorage.getItem("token") || null;
      }

      function authHeaders() {
        const headers = { "Content-Type": "application/json" };
        const token = getToken();
        if (token) headers["Authorization"] = "Bearer " + token;
        return headers;
      }

      function formatPrice(num) {
        if (typeof num !== "number") return "‚Çπ0";
        return "‚Çπ" + num.toLocaleString("en-IN");
      }

      function renderStars(rating) {
        const full = Math.round(rating);
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += i <= full ? "‚òÖ" : "‚òÜ";
        }
        return stars;
      }

      navCart.addEventListener("click", () => {
        window.location.href = "/cart.html";
      });

      // ====== LOAD CART COUNT (optional) ======

      async function loadCartCount() {
        const token = getToken();
        if (!token) {
          cartCountEl.textContent = "0";
          return;
        }
        try {
          const res = await fetch("/api/cart", {
            method: "GET",
            headers: authHeaders(),
          });
          if (!res.ok) {
            cartCountEl.textContent = "0";
            return;
          }
          const cart = await res.json();
          const items = cart.items || [];
          const total = items.reduce(
            (sum, item) => sum + (item.quantity || 0),
            0
          );
          cartCountEl.textContent = total;
        } catch (e) {
          cartCountEl.textContent = "0";
        }
      }

      // ====== LOAD PRODUCT ======

      async function loadProduct() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");

        if (!productId) {
          productTitleEl.textContent = "Product not found";
          productDescriptionEl.textContent =
            "No product ID in URL. Open this page using the Details button.";
          return;
        }

        try {
          const res = await fetch(`/api/products/${productId}`);
          if (!res.ok) {
            throw new Error("Failed to fetch product");
          }
          const product = await res.json();
          currentProduct = product;
          renderProduct(product);
        } catch (err) {
          console.error(err);
          productTitleEl.textContent = "Failed to load product";
          productDescriptionEl.textContent =
            "Check that your backend /api/products/:id route is working.";
        }
      }

      function renderProduct(p) {
        // image
        imageWrap.innerHTML = p.image
          ? `<img src="${p.image}" alt="${p.title}" />`
          : `<span style="font-size:3rem; opacity:0.35;">üì¶</span>`;

        // text
        productTitleEl.textContent = p.title || "Untitled product";
        productPriceEl.textContent = formatPrice(p.price);
        buyPriceEl.textContent = formatPrice(p.price);
        productDescriptionEl.textContent =
          p.description || "No description available.";
        breadcrumbCategory.textContent = p.category || "Product";
        categoryBadgeEl.textContent = p.category || "Featured";

        const inStock =
          typeof p.countInStock === "number" ? p.countInStock > 0 : true;

        stockStatusEl.textContent = inStock
          ? `${
              typeof p.countInStock === "number"
                ? p.countInStock + " left in stock"
                : "In stock"
            }`
          : "Currently unavailable";

        stockStatusEl.style.color = inStock ? "#bbf7d0" : "#fecaca";

        // rating
        const rating = p.rating || 0;
        const numReviews = p.numReviews || 0;

        ratingStarsEl.textContent = renderStars(rating);
        ratingValueEl.textContent = rating
          ? rating.toFixed(1) + " / 5"
          : "No rating yet";
        reviewCountEl.textContent =
          numReviews + (numReviews === 1 ? " review" : " reviews");

        // reviews list
        renderReviews(p.reviews || []);
      }

      function renderReviews(reviews) {
        reviewsListEl.innerHTML = "";
        if (!reviews.length) {
          reviewsListEl.innerHTML =
            '<div style="font-size:0.8rem;color:#9ca3af;margin-top:0.3rem;">No reviews yet. Be the first to review this product.</div>';
          return;
        }

        reviews
          .slice()
          .reverse()
          .forEach((r) => {
            const div = document.createElement("div");
            div.className = "review-item";

            const date = r.createdAt
              ? new Date(r.createdAt).toLocaleDateString("en-IN")
              : "";

            div.innerHTML = `
              <div class="review-header">
                <div>
                  <div class="review-name">${r.name || "Anonymous"}</div>
                  <div class="review-stars">${renderStars(r.rating || 0)}</div>
                </div>
                <div class="review-date">${date}</div>
              </div>
              <div class="review-text">${r.comment || ""}</div>
            `;
            reviewsListEl.appendChild(div);
          });
      }

      // ====== ADD TO CART / BUY NOW ======

      async function addToCart() {
        if (!currentProduct?._id) return;
        const token = getToken();
        if (!token) {
          buyStatusEl.textContent =
            "Please login on the home page to add to cart.";
          buyStatusEl.className = "status error";
          return;
        }

        try {
          buyStatusEl.textContent = "Adding to cart‚Ä¶";
          buyStatusEl.className = "status";

          const res = await fetch("/api/cart/add", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({
              productId: currentProduct._id,
              quantity: 1,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            console.error(data);
            buyStatusEl.textContent = data.message || "Failed to add to cart.";
            buyStatusEl.className = "status error";
            return;
          }

          const totalItems = data.cart.items.reduce(
            (sum, item) => sum + (item.quantity || 0),
            0
          );
          cartCountEl.textContent = totalItems;

          buyStatusEl.textContent = "Added to cart.";
          buyStatusEl.className = "status success";
        } catch (err) {
          console.error(err);
          buyStatusEl.textContent = "Failed to add to cart.";
          buyStatusEl.className = "status error";
        }
      }

      addToCartBtn.addEventListener("click", async () => {
        await addToCart(); // add item to cart
        window.location.href = "/cart.html"; // redirect to cart
      });

      // ====== SUBMIT REVIEW ======

      submitReviewBtn.addEventListener("click", async () => {
        const token = getToken();
        if (!token) {
          reviewStatusEl.textContent =
            "Please login on the home page to post a review.";
          reviewStatusEl.className = "status error";
          return;
        }

        const rating = reviewRatingEl.value;
        const comment = reviewCommentEl.value.trim();

        if (!rating || !comment) {
          reviewStatusEl.textContent =
            "Please select a rating and write a comment.";
          reviewStatusEl.className = "status error";
          return;
        }

        try {
          reviewStatusEl.textContent = "Submitting review‚Ä¶";
          reviewStatusEl.className = "status";

          const res = await fetch(
            `/api/products/${currentProduct._id}/reviews`,
            {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify({ rating, comment }),
            }
          );

          const data = await res.json();

          if (!res.ok) {
            console.error(data);
            reviewStatusEl.textContent =
              data.message || "Failed to submit review.";
            reviewStatusEl.className = "status error";
            return;
          }

          reviewStatusEl.textContent = "Review added!";
          reviewStatusEl.className = "status success";
          reviewRatingEl.value = "";
          reviewCommentEl.value = "";

          // refresh product data (with new review)
          currentProduct = data.product;
          renderProduct(currentProduct);
        } catch (err) {
          console.error(err);
          reviewStatusEl.textContent = "Error submitting review.";
          reviewStatusEl.className = "status error";
        }
      });

      // ====== INIT ======
      loadProduct();
      loadCartCount();
    </script>
  </body>
</html>
